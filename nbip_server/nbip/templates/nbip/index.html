{% extends "nbip/base.html" %}

{% block page-header %}
<!-- <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.16.4/jquery.tablesorter.min.js"/> -->
{% endblock %}

{% block page-css %}

#highscore thead th {
	text-align:center;
}
#highscore thead th:nth-child(2) {
	text-align:left;
}

#highscore tbody td {
	text-align:right;
}
#highscore tbody td:nth-child(2) {
	text-align:left;
}

ul.contributions {
	max-height:12em;
	overflow-y:auto;

}

{% endblock %}

{% block page-js %}

var highscorerows = [];

// General helper to animate a few things
function smooth_highscore (callback) {
	var pos_now = {};
	$("#highscore tbody tr").each(function (i,e) {
		pos_now[$(e).data('user_id')] = $(e).offset();
	});

	callback();

	// animate all motion
	$("#highscore tbody tr").each(function (i,e) {
		var e_pos_now = pos_now[$(e).data('user_id')];
		if (e_pos_now) {
			var e_pos_target = $(e).offset();

			$(e).find("td > *").css('position', 'relative');
			$(e).find("td > *").css('top', e_pos_now.top - e_pos_target.top);
			$(e).find("td > *").css('left', e_pos_now.left - e_pos_target.left);
			$(e).find("td > *").animate({left: 0, top: 0});
		}
	});
}


function perc(a,b) {
	if (a + b > 0) {
		return (a / (a + b)).toFixed(3);
	} else {
		return "–";
	}
}

function score(r) {
    return Math.pow((1+r[2]) * (1+r[3]) * (1+r[4]/10), 0.5)
        * (r[5] + 1) / (r[5] + r[6] + 1)
        * (r[7] + 1) / (r[7] + r[8] + 1)
}

function cell(c) {
	return $("<td>").append($("<div>").text(c));
}

function fillhighscoretable() {smooth_highscore(function() { 
    $("#highscore tbody").empty();
    jQuery.map(highscorerows, function(rowdata,i) {
	var r = $("<tr>").append([
		cell(i+1),
		cell(rowdata[1]),
		cell(rowdata[2]),
		cell(rowdata[3]),
		cell(rowdata[4]),
		cell(rowdata[5]),
		cell(rowdata[6]).addClass("small"),
		cell(rowdata[7]),
		cell(rowdata[8]).addClass("small"),
		cell(rowdata[9].toFixed(3)),
	]).data('user_id', rowdata[0]);
	$("#highscore tbody").append(r);
    });
});}


function update_highscore() {
    $.getJSON("{% url "highscore_data" %}")
	.done(function (data) {
		highscorerows = jQuery.map(data['rows'], function (row) {
            return [[
                row[0],
                row[1],
                row[2],
                row[3],
                row[4],
                row[5],
                perc(row[5], row[6]),
                row[7],
                perc(row[7], row[8]),
                score(row),
            ]]
        });
		highscorerows.sort(function (a,b) {
			return (b[9]) - (a[9]);
		});
		fillhighscoretable();
	});
    setTimeout(update_highscore, 30000);
}

$(function() {
    update_highscore();
})

{% endblock %}

{% block title %}Willkommen{% endblock %}

{% block content %}
<div class="container">
<p>Willkommen zum Programmierspiel der GPN’14.
Wir spielen mit {{ n_words }} {{ n_words | pluralize:"Wort,Wörtern" }} und {{ n_explanations }} Erklärung{{ n_explanations|pluralize:"en"}}.</p>
</div>

{% if user.is_authenticated %}
<div class="container">
 <div class="row">
  <div class="col-sm-3">
   <h3>
    Deine Wörter
    <a class="btn btn-default btn-xs" href="{% url 'submit' %}">
     <span class="glyphicon glyphicon-plus"></span>
    </a>
   </h3>
   {% if words %}
    <ul class="list-group contributions">
     {% for w in words %}
      <li class="list-group-item">
       {{w}}
      </li>
     {% endfor %}
    </ul>
  {% else %}
   <p>
    Du hast noch keine Wörter eingericht.
    <a href="{% url 'submit' %}">Ändere das doch!</a>
   </p>
  {% endif %}
  </div>

  <div class="col-sm-6">
   <h3>
    Deine Erklärungen
    <a class="btn btn-default btn-xs" href="{% url 'explain' %}">
     <span class="glyphicon glyphicon-plus"></span>
    </a>
   </h3>
   {% if expls  %}
    <ul class="list-group contributions">
     {% for e in expls %}
      <li class="list-group-item">
       Ein/eine <strong>{{e.word}}</strong> ist ein/eine <strong>{{e.explanation}}</strong>.
      </li>
     {% endfor %}
    </ul>
  {% else %}
   <p>
    Du hast noch keine Erklärungen eingericht.
    <a href="{% url 'explain' %}">Ändere das doch!</a>
   </p>
  {% endif %}
  </div>

  <div class="col-sm-3">
   <h3>
    Deine Spiele
    <a class="btn btn-default btn-xs" href="{% url 'new_guess' %}">
     <span class="glyphicon glyphicon-plus"></span>
    </a>
   </h3>
   {% if gamerounds %}
    <ul class="list-group contributions">
     {% for g in gamerounds %}
      <li class="list-group-item">
       <a href="{% url "view_guess" g.pk %}">{{g.word}}</a>
      </li>
     {% endfor %}
    </ul>
  {% else %}
   <p>
    Du hast noch keine Rate-Runden gespielt.
    <a href="{% url 'new_guess' %}">Mach das doch jetzt!</a>
   </p>
  {% endif %}
  </div>
 </div>
</div>
{% endif %}

<div class="container">
 <h3>Highscores</h3>
 <table class="table" id="highscore">
   <colgroup>
    <col width="0%"/>
    <col width="100%"/>
    <col width="0%" span="3"/>
    <col width="0%" span="4"/>
  </colgroup>
  <thead>
   <tr>
     <th>#</th>
     <th>User</th>
     <th>Wörter</th>
     <th>Erklärungen</th>
     <th>Spiele</th>
     <th colspan="2">Richtig geraten</th>
     <th colspan="2">Andere reingelegt</th>
     <th>Score</th>
   </tr>
  <!--
   <tr>
     <th class="sorter-false">#</th>
     <th class="sorter-false">User</th>
     <th class="sorter-false">Wörter</th>
     <th class="sorter-false">Erklärungen</th>
     <th class="sorter-false">Spiele</th>
     <th class="sorter-false" colspan="2">Richtig geraten</th>
     <th class="sorter-false" colspan="2">Andere reingelegt</th>
   </tr>
   <tr>
     <th class="sorter-false"/>
     <th class="sorter-false"/>
     <th/>
     <th/>
     <th/>
     <th/>
     <th/>
     <th/>
     <th/>
    </tr>
   -->
  </thead>
  <tbody>
  </tbody>
 </table>

</div>


{% endblock %}
